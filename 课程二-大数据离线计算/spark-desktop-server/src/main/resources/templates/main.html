<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>Title</title>
    <link rel="stylesheet" th:href="@{/layui/css/layui.css}" media="all"/>
    <script type="text/javascript" th:src="@{/layui/layui.js}"></script>
    <link rel="stylesheet" th:href="@{/main/main.css}"/>
</head>
<body>
<div>
    <div id="show-window" class="layui-row">
        <div class="layui-col-xs6" id="show-tables-detail">
            <button style="margin: 10px 10px" class="layui-btn layui-btn-normal layui-layout-right" id="show-tables">
                数据表切换
                <i class="layui-icon layui-icon-down layui-font-10"></i>
            </button>
            <table style="margin-top: 45px" id="database-table"></table>
        </div>
        <div class="layui-col-xs6" id="command-window">
            <div style="height: 30px;">
                <button id="run-sqls" style="height: 20px; right: 15px; top: 10px; bottom: 0px; background-color: #ccc; border-radius: 3px"
                        class="layui-layout-right">运行
                </button>
            </div>
            <div style="height: calc(100vh * 0.4); padding: 0px 10px">
                <textarea id="prepare-sqls"></textarea>
            </div>
            <div style="height: calc((100vh * 0.6) - 75px); margin: 15px 10px; overflow-y: auto; font-size: 8px; line-height: 18px" id="result-window"
                 class="layui-bg-cyan"></div>
        </div>
    </div>
</div>
<script>
    layui.use(['layer', 'cookie', 'table', 'dropdown'], function () {
        let layer = layui.layer;
        let $ = layui.jquery;
        let table = layui.table;
        let dropdown = layui.dropdown;

        let connections = null
        let currentDatabaseName = null
        let currentTableName = null
        let precessedColumns = []
        let setTableConstructor = null
        let tablesDropdown = []

        window.renderIframe = function (index, connectionMap, databaseName) {
            connections = null
            connections = connectionMap
            currentDatabaseName = databaseName
            let test = $.ajax({
                url: "http://localhost:8080/api/execute-multi-sql",
                headers: {token: $.cookie('token')},
                data: {
                    'connection-host': connections.get("connection_host"),
                    'connection-port': connections.get("connection_port"),
                    'connection-database-name': connections.get("connection_database_name"),
                    'connection-username': connections.get("connection_username"),
                    'connection-password': connections.get("connection_password"),
                    'sql': 'use ' + databaseName + ';show tables'
                },
                type: "post",
                success: function (data) {
                    if (data.code === 200) {
                        tablesDropdown.length = 0
                        for (let j = 0; j < data.data[1].length; j++) {
                            let tempMap = new Object(null)
                            tempMap.title = data.data[1][j].tableName
                            tempMap.id = j
                            tempMap.href = '#'
                            tablesDropdown.push(tempMap)
                        }
                    }
                }
            })

            $.when(test).done(function () {
                dropdown.render({
                    elem: '#show-tables' //可绑定在任意元素中，此处以上述按钮为例
                    , data: tablesDropdown
                    , id: 'show-tables'
                    //菜单被点击的事件
                    , click: function (obj) {
                        let tableName = obj.title
                        currentTableName = tableName
                        let columns = []
                        let getTableDesc = $.ajax({
                            url: "http://localhost:8080/api/execute-multi-sql",
                            headers: {token: $.cookie('token')},
                            data: {
                                'connection-host': connections.get("connection_host"),
                                'connection-port': connections.get("connection_port"),
                                'connection-database-name': connections.get("connection_database_name"),
                                'connection-username': connections.get("connection_username"),
                                'connection-password': connections.get("connection_password"),
                                'sql': 'use ' + currentDatabaseName + ';desc ' + tableName
                            },
                            type: "post",
                            success: function (data) {
                                if (data.code === 200) {
                                    for (let j = 0; j < data.data[1].length; j++) {
                                        columns.push(data.data[1][j].col_name)
                                    }
                                }
                            }
                        })
                        setTableConstructor = $.when(getTableDesc).done(function () {
                            precessedColumns = []
                            precessedColumns.push({type: 'checkbox', fixed: 'left'})
                            for (let i = 0; i < columns.length; i++) {
                                let tempMap = new Object(null)
                                tempMap.field = columns[i]
                                tempMap.title = columns[i]
                                precessedColumns.push(tempMap)
                            }
                        })

                        $.when(setTableConstructor).done(function () {
                            table.render({
                                elem: "#database-table",
                                height: 750,
                                limit: 15,
                                url: "http://localhost:8080/api/get-table-data",
                                method: "POST",
                                headers: {token: $.cookie('token')},
                                where: {
                                    "database-name": currentDatabaseName,
                                    "table-name": currentTableName
                                },
                                page: true,
                                toolbar: true,
                                cols: [
                                    precessedColumns
                                ]
                            });
                        })
                    }
                });
            })
        }

        $(document).on('click', "#run-sqls", function () {
            console.log($('#prepare-sqls').val())
            let loading = layer.load(0, {
                shade: false,
                time: 60 * 1000
            })
            $.ajax({
                url: "http://localhost:8080/api/execute-multi-sql",
                headers: {token: $.cookie('token')},
                data: {
                    'connection-host': connections.get("connection_host"),
                    'connection-port': connections.get("connection_port"),
                    'connection-database-name': connections.get("connection_database_name"),
                    'connection-username': connections.get("connection_username"),
                    'connection-password': connections.get("connection_password"),
                    'sql': 'use ' + currentDatabaseName + ';' + $('#prepare-sqls').val()
                },
                type: "post",
                success: function (data) {
                    if (data.code === 200) {
                        layer.close(loading)
                        $('#result-window').empty()
                        for (let i = 0; i < data.data.length; i++) {
                            $('#result-window').append('<div>'+ formatJson(JSON.stringify(data.data[i])) +'</div>')
                        }
                    }
                }
            });
        })


        let formatJson = function (v, options) {
            v = v.replace(/&quot;/g, '"');
            v = v.replace(/ /g, '');
            var reg = /(\[|{|,)/g;
            v = v.replace(reg, function (a, b) {
                return a + "<br/>";
            });
            reg = /(}|\])/g;
            v = v.replace(reg, function (a, b) {
                return "<br/>" + a;
            });
            reg = /(:\[)/g;
            v = v.replace(reg, function (a, b) {
                return a[0] + "<br/>" + a[1];
            });

            var arr = v.toString().split("<br/>")

            var arr1 = new Array("[", "]");
            var arr2 = new Array("{", "}");
            var pre = "";
            v = "";

            var chr = "&nbsp;&nbsp;";
            var lth = chr.length;
            var prev = "";
            $.each(arr, function (index, item) {
                if (item == "[" || item == "{") {
                    if (pre != "}," && index != 0 && index & arr.length) {
                        prev += chr;
                    }
                    v += prev + item + "<br />";
                } else if (item == "]" || item == "}" || item == "},") {
                    prev = prev.substr(0, prev.length - lth);
                    v += prev + item + "<br />";
                } else {
                    if (pre == "{") {
                        prev += chr;
                    }
                    v += prev + item + "<br />";
                }

                pre = item;
            });

            var reg = /(&nbsp;".\w+")/g;
            v = v.replace(reg, function (a, b) {
                return "<span style=\"color:#92278F;\">" + a + "</span>";
            });
            reg = /((:\s*\"([^\"]*)\"(,?))|(:\s*(\d+(\.\d)*|null)+[,]?))/g;
            v = v.replace(reg, function (a, b) {
                return "<span style=\"color:#3AB54A;\">" + a + "</span>";
            });
            return v;
        };
    });
</script>
</body>
<style>
    textarea {
        width: calc(100% - 15px);
        height: calc(100% - 20px);
        resize: none;
        margin: 10px 0px;
        padding: 5px;
        font-size: 18px;
        outline: none;
        text-shadow: 0px 1px 0px #fff;
        -webkit-border-radius: 3px;
        -moz-border-radius: 3px;
        border-radius: 3px;
        border: 1px solid #ccc;
        -webkit-transition: .3s ease-in-out;
        -moz-transition: .3s ease-in-out;
        -o-transition: .3s ease-in-out;
    }

    textarea:focus {
        border: 1px solid #fafafa;
        -webkit-box-shadow: 0px 0px 6px #007eff;
        -moz-box-shadow: 0px 0px 5px #007eff;
        box-shadow: 0px 0px 5px #007eff;
    }
</style>
</html>

